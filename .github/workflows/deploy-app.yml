name: deploy-app
on:
  push:
    branches: [master, develop]
jobs:
  test:
    name: Test app before pushing
    runs-on: ubuntu-latest
    steps:
      uses: [actions/checkout@v2, actions/setup-node@v1]
      run: npm run test
  deploy:
    name: Deploy app to server
    description: Pull code from repo on server and restart Docker container
    runs-on: ubuntu-latest
    steps:
      uses: appleboy/ssh-action@v0.1.2
      with:
        host: ${{secrets.SSH_HOST}}
        username: ${{secrets.SSH_USERNAME}}
        password: ${{secrets.SSH_PASSWORD}}
        script: |
          cd apps/photography
          ls -a
          cd worldwide-photography-client
          npm -v
          git pull origin $(git rev-parse --abbrev-ref HEAD)
          npm install
          docker build -t worldwide-photography-client:0.1 .
          docker run --publish 8081:8081 --detach --name wphoto-client worldwide-photography-client:0.1
          echo 'Deploy complete'
